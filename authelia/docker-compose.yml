version: '3'
networks:
  proxiedNet:
    external: true
  database:
    external: true

secrets:
  jwt_secret:
    file: ./secrets/jwt_secret
  storage_encryption_key:
    file: ./secrets/storage_encryption_key
  storage_postgress_password:
    file: ./secrets/postgresql_password
  hmac_secret:
    file: ./secrets/oidc/hmac_secret
  issuer_private_key:
    file: ./secrets/oidc/keys/private.pem

services:
  authelia:
    image: authelia/authelia:latest
    container_name: authelia
    command:
      - "authelia"
      - "--config=/config/configuration.yml"
      - "--config=/config/configuration.acl.yml"
      - "--config=/config/configuration.identity_providers.yml"
    secrets:
      - jwt_secret
      - storage_encryption_key
      - storage_postgress_password
      - hmac_secret
      - issuer_private_key
    environment:
      AUTHELIA_JWT_SECRET_FILE: /run/secrets/jwt_secret
      AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE: /run/secrets/storage_encryption_key
      AUTHELIA_STORAGE_POSTGRES_PASSWORD_FILE: /run/secrets/storage_postgress_password
      AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET_FILE: /run/secrets/hmac_secret
      AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY_FILE: /run/secrets/issuer_private_key
    env_file:
      - .env
    volumes:
      - ./config:/config
    networks:
      - proxiedNet
      - database
    # expose:
    #   - 9091
    restart: unless-stopped
